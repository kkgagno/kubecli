{% extends 'base.html' %}

{% block title %}Compliance Reports{% endblock %}

{% block content %}
    <h1>Compliance Reports</h1>

    <!-- Controls -->
    <div class="row mb-3">
        <!-- Dropdown Selector -->
        <div class="col-md-6">
            <label for="reportSelector" class="form-label">Select a report to view:</label>
            <select id="reportSelector" class="form-select">
                {% for report in reports %}
                    <option value="{{ report }}" {% if report == default_report %}selected{% endif %}>
                        {{ report }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <!-- Search Controls -->
        <div class="col-md-6">
            <label class="form-label">Download Report:</label>
            <div class="dropdown">
                <button class="btn btn-success dropdown-toggle" type="button" id="downloadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    Download
                </button>
                <ul class="dropdown-menu" aria-labelledby="downloadDropdown">
                    <li><a class="dropdown-item" href="#" id="downloadPdf">PDF (Selected Report)</a></li>
                    <li><a class="dropdown-item" href="{{ url_for('download_summary_csv') }}" id="downloadCsv">CSV (All Reports)</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <button class="btn btn-info me-2" id="runOscapScanButton" data-bs-toggle="tooltip" title="This will kick off OpenSCAP for compliance reporting across your kubernetes cluster nodes, run at times of low usage">Run OpenSCAP Scan</button>
            <a href="{{ url_for('archived_reports') }}" class="btn btn-secondary">View Archived Reports</a>
        </div>
    </div>

    <div id="playbookStatus" class="mt-3 alert d-none" role="alert"></div>
    <pre id="playbookOutput" class="bg-light p-3 border rounded" style="max-height: 300px; overflow-y: scroll; display: none;"></pre>

    <!-- Iframe to display report -->
    {% if reports %}
        <iframe id="report-frame" src="{{ url_for('static', filename='oscap_reports/' + default_report if default_report else '') }}" width="100%" height="800px" frameborder="0"></iframe>
    {% else %}
        <div class="alert alert-info" role="alert">
            No reports found. Click "Run OpenSCAP Scan" to generate reports.
        </div>
    {% endif %}

    <!-- Confirmation Modal -->
    <div class="modal fade" id="oscapConfirmationModal" tabindex="-1" aria-labelledby="oscapConfirmationModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="oscapConfirmationModalLabel">Confirm Action</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            This will kick off OpenSCAP for compliance reporting across your Kubernetes cluster nodes and may affect performance. This is a lengthy process, please be patient. Are you sure you want to continue?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmRunOscapButton">Yes, Run Scan</button>
          </div>
        </div>
      </div>
    </div>

    {% block scripts %}
    <script src="{{ url_for('static', filename='js/compliance.js') }}"></script>
{% endblock %}
{% endblock %}