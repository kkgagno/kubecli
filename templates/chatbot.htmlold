{% extends 'base.html' %}

{% block title %}Llama3 Chatbot{% endblock %}

{% block content %}
<div class="container-fluid h-100">
    <div class="row h-100">
        <div class="col-12">
            <div class="card h-100" style="background-color: #343a40; color: white;">
                <div class="card-header">
                    <h5 class="card-title mb-0">Llama3 Chatbot</h5>
                </div>
                <div class="card-body" id="chat-body" style="overflow-y: auto; height: 60vh;">
                    <!-- Chat messages will be appended here -->
                </div>
                <div class="card-footer">
                    <form id="chat-form">
                        <div class="input-group">
                            <input type="text" id="user-input" class="form-control" placeholder="Type your message...">
                            <select id="model-selector" class="form-select">
                                <option value="tinyllama">tinyllama</option>
                            </select>
                            <button type="submit" class="btn btn-primary">Send</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatBody = document.getElementById('chat-body');
    const modelSelector = document.getElementById('model-selector');

    // Fetch available models and populate the dropdown
    function fetchModels() {
        fetch('/ollama_models')
            .then(response => response.json())
            .then(data => {
                modelSelector.innerHTML = '';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    modelSelector.appendChild(option);
                });
            });
    }

    fetchModels();

    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const userMessage = userInput.value;
        if (!userMessage) return;

        appendMessage('You', userMessage);
        userInput.value = '';

        fetch('/chatbot', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ message: userMessage, model: modelSelector.value })
        })
        .then(response => response.json())
        .then(data => {
            appendMessage(modelSelector.value, data.response);
        })
        .catch(error => {
            console.error('Error:', error);
            appendMessage('Error', 'An error occurred while processing your request.');
        });
    });

    function appendMessage(sender, message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('mb-2');
        if (sender !== 'You' && sender !== 'Error') {
            messageElement.innerHTML = `<strong>${sender}:</strong> ${marked.parse(message)}`;
        } else {
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
        }
        chatBody.appendChild(messageElement);
        chatBody.scrollTop = chatBody.scrollHeight;
    }
});
</script>
{% endblock %}
